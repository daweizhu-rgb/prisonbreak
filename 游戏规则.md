# 《警察与逃犯》游戏规则说明

## 一、胜负条件

- **逃犯胜利**：游戏开始后存活 **60 秒** 且未被警察碰到、未被警察子弹击中。
- **警察胜利**：满足以下任一条件即判警察胜：
  - 任意警察与逃犯发生**身体碰撞**；
  - 逃犯被**警察子弹**击中。

游戏结束后时间停止，可点击 **Restart** 重新开始。

---

## 二、场地与设施

- **楼层**：共 **5 层**（1F～5F），从左到右为平台，左侧标有楼层数字。
- **爬梯**：共 **9 架**，每局开始随机水平位置且互不重叠：
  - 4 架短梯（相邻两层）：1–2、2–3、3–4、4–5；
  - 3 架中梯（跨两层）：1–3、2–4、3–5；
  - 2 架长梯（跨三层）：1–4、2–5。
- **滑梯**：一条从 **5F 到 1F** 的滑梯；上下端点的 **X 坐标** 每 **30 秒** 随机变化一次（Y 固定为 5F/1F 高度）。在 5F 滑梯入口处按 **↓** 可进入滑梯；滑行中按 **↑** 可中途停下并落在当前高度最近楼层。

---

## 三、初始位置

- **逃犯**：始终出现在 **5 楼（最上层）右侧**。
- **警察**：三名警察（A、B、C）均在**最左侧**：**A 在 3 楼**，**B 在 2 楼**，**C 在 1 楼**。

---

## 四、逃犯（玩家）操作

- **移动**：
  - **← →**：在平台水平移动；
  - **↑ ↓**：在梯子 X 范围内上下梯；可与梯子经过的任意楼层对齐后横向离开梯子。
- **爬梯时按左右键**：可横向移出当前梯子，随后**自由落体**落下，并会：
  - 若落在**旁边另一架梯子**上，则切换到该梯子继续爬；
  - 若在 5F 且落入**滑梯入口**，则进入滑梯；
  - 否则落在**脚下或下方的楼层**平台（不会“跳”到上一层）。
- **跳跃**：仅在地面（非梯子、非滑梯）按 **空格**，跳跃高度约为逃犯身高的 2 倍。
- **速度**：平地比警察快，爬梯、滑梯速度均高于警察；警察不使用滑梯。

---

## 五、警察（AI）

- **移动**：AI 追逃犯（预测、选梯子）；平地与爬梯速度均慢于逃犯，且**不使用滑梯**。
- **射击**：仅当与逃犯**同层**时可能射击；每名警察 **10 秒** 冷却；每帧至多一名警察发射一发红色子弹，朝逃犯方向。

### 5.1 追捕逻辑（当前实现）

**1. 共享情报**

- 三名警察共享一份「最后看到的逃犯位置」：
  - `last_known_prisoner_floor`：最后看到的楼层（0=1楼 … 4=5楼）
  - `last_known_prisoner_x`：该位置的水平 x（带一点预测：逃犯当前 x + 速度×0.28 秒）
- **何时更新**：任一警察**看到逃犯**时，立即更新上述共享情报。
- **何时视为看到**：
  - 与逃犯**同层**（同一楼层），或
  - **同梯**：警察与逃犯在同一架梯子的同一竖条（x 相近），且两人所在楼层都在该梯子覆盖范围内。
- 重新开始游戏时，共享情报会清空。

**2. 本帧目标（target_floor_0、target_x）**

每帧按以下**优先级**决定该警察本帧要去的楼层和水平目标 x：

| 情况 | 目标楼层 | 目标 x |
|------|----------|--------|
| **看到逃犯** | 逃犯当前楼层 | 预测逃犯 x + 本警察的 chase_offset |
| **有情报、且未触发“情报过期”** | 情报中的楼层 | 情报 x + chase_offset |
| **无情报 或 情报过期** | 见下方 A/B/C 分工 | 见下方 |

- **chase_offset**：A = -40，B = 0，C = +40（三人略微错开，避免完全重叠）。

**3. 情报过期**

- 若**本帧没有看到逃犯**，且**有情报**，且**当前所在楼层就是情报里的楼层**，则**一律视为情报过期**，本帧不再按情报追，而是按「无情报」的巡逻/搜索来算目标。
- 这样避免三人挤在通报层不动（例如逃犯已到 1 楼，情报还写着 2 楼时，三人会从 2 楼散开去各自巡逻目标）。

**4. 无情报时的分工（巡逻/搜索）**

- **A（police_index=0）**  
  - 目标楼层：**5 楼**。  
  - 若未到 5 楼：目标 x = 屏幕水平中心，先找梯子上 5 楼。  
  - 若已在 5 楼：在 5 楼左右巡逻；碰到左边界（x≤40）改为向右，碰到右边界改为向左，目标 x = 当前 x ± 300。

- **B（police_index=1）**  
  - 目标楼层：**1 楼**。  
  - 若未到 1 楼：目标 x = 屏幕水平中心，先找梯子下 1 楼。  
  - 若已在 1 楼：在 1 楼左右巡逻；边界与目标 x 规则同 A。

- **C（police_index=2）**  
  - 目标楼层：在 **2 楼、3 楼、4 楼** 之间循环（c_search_target = 1,2,3 对应 2楼、3楼、4楼）。  
  - 当 C **站在目标楼层的平台上**（当前楼层 = c_search_target 且本帧不在梯子上）时，切换到下一目标：  
    - 若当前向上搜：2→3→4→ 到 4 后改为向下搜（目标 3）；  
    - 若当前向下搜：4→3→2→ 到 2 后改为向上搜（目标 3）。  
  - 目标 x 始终为屏幕水平中心。

**5. 同层时的水平移动**

- 若**当前楼层 = 目标楼层**：  
  - 若与目标 x 相差 **≥8 像素**：朝目标 x 方向水平移动。  
  - 若与目标 x 相差 **<8 像素** 且**本帧看到逃犯**：改为朝逃犯当前 x 方向移动（便于瞄准、射击）。  
  - 若与目标 x 相差 <8 且**没看到逃犯**：本帧不设水平速度（若已触发情报过期，目标会在上一步被改成巡逻，下一帧会去别的楼层）。

**6. 不同层时：选梯子、爬梯**

- 若**当前楼层 ≠ 目标楼层**：  
  - 用 `find_best_ladder_towards_floor` 在**当前楼层**的梯子中，选一架**朝目标楼层方向**的梯子；若有情报则优先选离「情报 x」更近的梯子，否则选离当前自己 x 更近的。  
  - 若该梯子已被其他警察占用，则在同一层选另一架未被占用的梯子（仍按与 goal_x、与自己的距离排序）。  
  - 先**水平靠近**该梯子（与梯子中心 x 差 ≤4 像素后视为到位），再**上下爬梯**（vy 方向由目标楼层与当前楼层关系决定）。  
  - 爬梯时：按**移动方向**在梯子**顶端/底端**正确落地（向上爬则落到梯子顶层，向下爬则落到底层）。

**7. 其他**

- 梯子占用：若另一名警察正在使用某架梯子（on_ladder 且 climbing_ladder 为该梯），本帧选梯时会尽量避开该梯。  
- 砖块：同层且与砖块重叠时，水平移动会被阻挡，不会穿砖。  
- 射击：与逃犯同层且冷却好时，由 `try_police_shoot` 统一处理，每帧至多一名警察开一枪，朝逃犯方向。

---

## 六、子弹与碰撞

- **警察子弹（红）**：击中逃犯 → 警察胜；不击中警察。
- 逃犯无射击能力。

---

## 七、其他

- **暂停**：窗口失去焦点（如点击窗口外、最小化）时游戏暂停，计时暂停，画面顶部显示 “Pause”；重新激活窗口后继续游戏。
- **重新开始**：游戏结束后点击 **Restart** 按钮（位于 1 层楼下方），重新生成梯子与角色，清空子弹等，开始新一局。

---

## 八、操作键汇总

| 按键       | 功能           |
|------------|----------------|
| ← → ↑ ↓    | 移动 / 爬梯 / 滑梯中按 ↑ 停下 |
| 空格       | 地面跳跃       |
